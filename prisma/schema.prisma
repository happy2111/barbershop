generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model company {
  id        Int      @id @default(autoincrement())
  name      String
  domain    String?  @unique
  createdAt DateTime @default(now())

  webAppUrl        String?
  telegramBotToken String?

  telegramChatId   String?
  telegramEnabled  Boolean @default(false)
  marketingEnabled Boolean @default(false)

  specialists       specialist[]
  services          service[]
  serviceCategories service_category[]
  clients           client[]
  bookings          booking[]
  schedules         schedule[]

  telegramTokens TelegramLinkToken[]

  @@map("companies")
}

model TelegramLinkToken {
  id        Int      @id @default(autoincrement())
  companyId Int
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)

  company company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("telegram_link_tokens")
}

model specialist {
  id        Int @id @default(autoincrement())
  companyId Int

  name         String
  phone        String
  password     String
  role         Role    @default(SPECIALIST)
  photo        String?
  description  String?
  skills       String?
  refreshToken String?

  company   company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  schedules schedule[]
  bookings  booking[]
  services  specialist_service[]

  @@unique([companyId, phone])
  @@map("specialists")
}

model service_category {
  id        Int    @id @default(autoincrement())
  companyId Int
  name      String

  company  company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  services service[]

  @@unique([companyId, name])
  @@map("service_categories")
}

model service {
  id           Int     @id @default(autoincrement())
  companyId    Int
  name         String
  price        Float
  duration_min Int
  categoryId   Int
  photo        String?

  company     company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category    service_category     @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  bookings    booking[]
  specialists specialist_service[]

  @@map("services")
}

model specialist_service {
  id           Int @id @default(autoincrement())
  specialistId Int
  serviceId    Int

  specialist specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  service    service    @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([specialistId, serviceId])
  @@map("specialist_services")
}

model client {
  id        Int     @id @default(autoincrement())
  companyId Int
  name      String?
  phone     String

  telegramId        BigInt? @unique
  telegramUsername  String?
  telegramFirstName String?
  telegramLastName  String?
  telegramLang      String?

  createdAt DateTime @default(now())

  company  company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bookings booking[]

  @@unique([companyId, phone])
  @@unique([companyId, telegramId])
  @@map("clients")
}

model schedule {
  id           Int    @id @default(autoincrement())
  companyId    Int
  specialistId Int
  day_of_week  Int
  start_time   String
  end_time     String

  company    company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  specialist specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)

  @@unique([specialistId, day_of_week])
  @@map("schedules")
}

model booking {
  id           Int           @id @default(autoincrement())
  companyId    Int
  clientId     Int?
  specialistId Int
  serviceId    Int?
  date         DateTime
  start_time   String
  end_time     String
  status       BookingStatus @default(PENDING)
  isSystem     Boolean       @default(false)
  reason       String?

  company    company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client     client?    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  specialist specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  service    service?   @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("bookings")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum Role {
  ADMIN
  SPECIALIST
}
